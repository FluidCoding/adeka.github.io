<!DOCTYPE html>
<html>
<head>
	<title>Kewl top Down shit</title>

	//<link href="assets/demoStyles.css" rel="stylesheet" type="text/css" />

	<!-- Note: All core EaselJS classes are listed here: -->
	<script type="text/javascript" src="src/createjs/events/Event.js"></script>
	<script type="text/javascript" src="src/createjs/events/EventDispatcher.js"></script>
	<script type="text/javascript" src="src/createjs/utils/IndexOf.js"></script>
	<script type="text/javascript" src="src/easeljs/utils/UID.js"></script>
	<script type="text/javascript" src="src/easeljs/utils/Ticker.js"></script>
	<script type="text/javascript" src="src/easeljs/geom/Matrix2D.js"></script>
	<script type="text/javascript" src="src/easeljs/geom/Point.js"></script>
	<script type="text/javascript" src="src/easeljs/geom/Rectangle.js"></script>
	<script type="text/javascript" src="src/easeljs/display/Shadow.js"></script>
	<script type="text/javascript" src="src/easeljs/display/SpriteSheet.js"></script>
	<script type="text/javascript" src="src/easeljs/display/Graphics.js"></script>
	<script type="text/javascript" src="src/easeljs/display/DisplayObject.js"></script>
	<script type="text/javascript" src="src/easeljs/display/Container.js"></script>
	<script type="text/javascript" src="src/easeljs/display/Stage.js"></script>
	<script type="text/javascript" src="src/easeljs/display/Bitmap.js"></script>
	<script type="text/javascript" src="src/easeljs/display/Sprite.js"></script>
	<script type="text/javascript" src="src/easeljs/display/BitmapAnimation.js"></script>
	<script type="text/javascript" src="src/easeljs/display/BitmapText.js"></script>
	<script type="text/javascript" src="src/easeljs/display/Shape.js"></script>
	<script type="text/javascript" src="src/easeljs/display/Text.js"></script>
	<script type="text/javascript" src="src/easeljs/display/DOMElement.js"></script>
	<script type="text/javascript" src="src/easeljs/events/MouseEvent.js"></script>
	<script type="text/javascript" src="src/easeljs/filters/Filter.js"></script>
	<script type="text/javascript" src="src/easeljs/ui/ButtonHelper.js"></script>
	<script type="text/javascript" src="src/easeljs/ui/Touch.js"></script>
	<script type="text/javascript" src="src/easeljs/utils/SpriteSheetUtils.js"></script>
	<script type="text/javascript" src="src/easeljs/utils/SpriteSheetBuilder.js"></script>
    <script type="text/javascript" src="src/simplex-noise.js"></script>
	<script type="text/javascript" src="src/easeljs/filters/ColorFilter.js"></script>
	<script type="text/javascript" src="src/easeljs/filters/ColorMatrixFilter.js"></script>
	<!-- We also provide hosted minified versions of all CreateJS libraries.
	  http://code.createjs.com -->

	<script type="text/javascript">
	var canvas;
	var stage;
    var tiles = [];
    var smiley;
    var moving = false;
    var speed = 3;

    var KEYCODE_ENTER = 13;
	var KEYCODE_SPACE = 32;
	var KEYCODE_UP = 38;
	var KEYCODE_LEFT = 37;
	var KEYCODE_RIGHT = 39;
	var KEYCODE_W = 87;
    var KEYCODE_S = 83;
	var KEYCODE_A = 65;
	var KEYCODE_D = 68;
    var KEYCODE_F = 70;
    var xVel = 0;
    var yVel = 0;
    var right = false, down = false;
    var counter = 0;
	document.onkeydown = handleKeyDown;
	document.onkeyup = handleKeyUp;

    function Hero(){



    }

    function Creep(){



    }

	function init() {
	    canvas = document.getElementById('myCanvas');
	    width = canvas.width;
	    height = canvas.height;
	    stage = new createjs.Stage(canvas);
        smiley = drawSmiley();
		smiley.x = 400;
		smiley.y = 400;
	    stage.addChild(smiley);

        var simplex = new SimplexNoise();
        var simplex2 = new SimplexNoise();

        var mapSize = 200;
        var tileCount = mapSize*mapSize;
        var xPos = 0, yPos = 0;

        for(var i=0;i< tileCount;i++){
            if(i % mapSize == 0){
                xPos = 0;
                yPos += 1;
            }
            else{
                xPos += 1;
            }
            var type;
            var blurNoise = simplex.noise2D(xPos/20, yPos/20) * 10;
            var landNoise = simplex.noise2D(xPos/8, yPos/8) * 15;
            var noise = simplex.noise2D(xPos, yPos) * 10;
            var decalNoise = simplex2.noise2D(xPos, yPos) * 10;
            var yOffset = 0;
            if(blurNoise > 4){
                type = 3;
                yOffset = 13;
            }
            else if(blurNoise > 3){
                type = 2;
            }
            else{
                type = 0;
                yOffset = landNoise;
            }
            var tile = new Tile(type);
           // tile.s.setTransform(0,0,1,1,noise/5,0,0,0,0);
            //tile.s.set({:0});
            tile.s.x = xPos * 50 + 400 + tile.xOffset;
            tile.s.y = yPos * 50 + 400 + yOffset;
            if(type == 0 || type == 2){
                if(decalNoise > 9){
                var decal = new Decal(0);
                tile.AddDecal(decal);
                }
                else if(landNoise > 8){
                var decal = new Decal(2);
                tile.AddDecal(decal);
                }
                else if(landNoise > 5){
                  var decal = new Decal(3);
                tile.AddDecal(decal);
                }
                else if(noise > 3){
                var decal = new Decal(1);
                tile.AddDecal(decal);
                }
            }

           // stage.update();
            tiles.push(tile);


        }


        		//start game timer
		if (!createjs.Ticker.hasEventListener("tick")) {
			createjs.Ticker.addEventListener("tick", tick);
		}

        createjs.Ticker.setInterval(60);
        createjs.Ticker.setFPS(60);
	    stage.update();
	}

	function drawSmiley() {
        //32x24
        var s = new createjs.Bitmap("assets/hero.png");
	    return s;
	}

    function Tile(type) {
        this.xOffset = 0;
        this.type = type;
        var s;
         this.rando = Math.random() * 2;
        switch (type)
        {
            case 0:
                s = new createjs.Bitmap("assets/grass.png");
                //s.set({alpha :.6});
               // var tint = new createjs.ColorFilter(1,0,0,1); // (red, green, blue, alpha)
	           // var bmp = s.clone();
	        	//bmp.filters = [tint];
	        	//bmp.cache(s.x, s.y, 50, 50);
                 //   s = bmp;
                break;
            case 1:
                s = new createjs.Bitmap("assets/rock.png");

                break;
            case 2:
                s = new createjs.Bitmap("assets/dirt.png");
                break;
            case 3:
                s = new createjs.Bitmap("assets/water.png");
                s.set({alpha :.3, regX : 0});
                //this.xOffset = 25;
                break;
        }
        this.s = s;
        this.AddDecal = AddDecal;
        function AddDecal(decal){
            this.decal = decal;
            decal.s.x = s.x + decal.xOffset;
            decal.s.y = s.y + decal.yOffset;

        }
        this.UseDecal = function UseDecal(){
            this.decal.Use();
            this.decal = null;
        }
        this.Update = function Update(){

            if(this.type == 2){
               // s.set({scaleX : 1 + Math.sin((counter)/50 + this.rando)/10})*2;
               //  s.set({scaleY : 1 + Math.sin((counter)/50 + this.rando)/1000});
                s.set({alpha :.3 + Math.sin((counter)/50 + this.rando)/20});
               // s.set({skewX : -1 + Math.sin((counter)/25) * 4});
                //s.set({skewY : -1 + Math.sin((counter)/25) * 4});
            }
        }
	}

    function Decal(type) {
        this.type = type;
        var s;
        this.rando = Math.random() * 2;
        switch (type)
        {
            case 0:
                s = new createjs.Bitmap("assets/brownchest.gif");
                    this.xOffset = 10;
                    this.yOffset = 10;
                break;
            case 1:
               s = new createjs.Bitmap("assets/tree.png");
               var rand = Math.random() + .8;
              //setTransform ( [x=0]  [y=0]  [scaleX=1]  [scaleY=1]  [rotation=0]  [skewX=0]  [skewY=0]  [regX=0]  [regY=0] )
                s.setTransform(0,0,rand,rand,0,0,0,25,80);
                    this.xOffset = 25;
                    this.yOffset = 30;
                break;
            case 2:
                var rand = Math.random()/2 + .8;
                s = new createjs.Bitmap("assets/rock.png");
                s.setTransform(0,0,rand,rand,0,0,0,10,60);
                this.xOffset = 10;
                this.yOffset = 10;
                break
            case 3:
                var rand = Math.random()/2 + .9;
                s = new createjs.Bitmap("assets/pine.png");
                s.setTransform(0,0,rand,rand,0,0,0,10,60);
                break
        }
        this.s = s;
        this.Use = function Use(){
            //
        }
        this.Update = function Update(){
            if(this.type == 1 || this.type == 3){
               // s.set({regX : 25, regY : 100});
                s.set({skewX : -1 + Math.sin((counter)/25 + this.rando) * 3});
                s.set({skewY : -1 + Math.sin((counter)/10 + this.rando) * 2});
            }
        }
	}

    //allow for WASD and arrow control scheme
	function handleKeyDown(e) {
		//cross browser issues exist
		if(!e){ var e = window.event; }
		switch(e.keyCode) {
			case KEYCODE_F:
                   // console.log("f");
                for(var i = 0; i < tiles.length; i++){
                    if(tiles[i].decal != null){
                        var tilex = tiles[i].s.x + stage.x;
                        var tiley = tiles[i].s.y + stage.y;
                        var distance = Math.sqrt(Math.pow( tilex - 400, 2) + Math.pow( tiley - 400, 2));
                        if(distance < 55){
                            tiles[i].UseDecal();
                        }
                    }
                }

                break;

			case KEYCODE_A: xVel = -speed; right = false; break;
			case KEYCODE_D: xVel = speed;  right = true; break;
			case KEYCODE_W: yVel = -speed; down = false; break;
            case KEYCODE_S: yVel = speed; down = true;  break;
		}
	}

	function handleKeyUp(e) {
		//cross browser issues exist
		if(!e){ var e = window.event; }
		switch(e.keyCode) {
			case KEYCODE_SPACE: break;

			case KEYCODE_A: if(!right) xVel = 0; break;
			case KEYCODE_D: if(right) xVel = 0; break;
			case KEYCODE_W: if(!down) yVel = 0; break;
            case KEYCODE_S: if(down) yVel = 0; break;
		}
	}


    function tick(event) {
        //stage.set({rotation : 33});
        counter++;
        stage.removeAllChildren();
        var colH = false;
        var colV = false;
        var heroDrawn = false;
        for(var i = 0; i < tiles.length; i++){
            var tilex = tiles[i].s.x + stage.x;
            var tiley = tiles[i].s.y + stage.y;
            var distance = Math.sqrt(Math.pow( tilex - 400, 2) + Math.pow( tiley - 400, 2));
            if(distance < 600){
                stage.addChild(tiles[i].s);
                tiles[i].Update();
            }
        }
        for(var i = 0; i < tiles.length; i++){

            var tilex = tiles[i].s.x + stage.x;
            var tiley = tiles[i].s.y + stage.y;
            var distance = Math.sqrt(Math.pow( tilex - 400, 2) + Math.pow( tiley - 450, 2));
            if(distance < 50){
              if(!heroDrawn){
                stage.addChild(smiley);
                heroDrawn = true;
              }
            }
            if(distance < 600){
                if(tiles[i].decal != null){
                    stage.addChild(tiles[i].decal.s);
                    tiles[i].decal.Update();
                }
            }
        }
        for(var i = 0; i < tiles.length; i++){
            if(tiles[i].type == 1 || tiles[i].decal || tiles[i].type == 3){
                if(((smiley.x + xVel < tiles[i].s.x + 40) &&
                    (smiley.x + xVel > tiles[i].s.x - 40)) &&
                   ((smiley.y < tiles[i].s.y + 15 ) &&
                    (smiley.y > tiles[i].s.y - 50 )))
                {
                    colH = true;
                }
                if(((smiley.x < tiles[i].s.x + 40) &&
                    (smiley.x > tiles[i].s.x - 40)) &&
                   ((smiley.y + yVel  < tiles[i].s.y + 15 ) &&
                    (smiley.y + yVel > tiles[i].s.y - 50 )))
                {
                   colV = true;
                }
            }
        }
        if(!colH){
            smiley.x += xVel;
            stage.x -= xVel;
        }
        if(!colV){
            smiley.y += yVel;
            stage.y -= yVel;
        }


        stage.update(event);
    }
	</script>

</head>
<body onload="init()">

	<header id="header" class="EaselJS">
	    <p>W A S D - keys to move, use F to destroy stuff</p>
	</header>

	<canvas id="myCanvas" width="800" height="800"></canvas>

</body>
</html>